# ~/.greeting — KUSH ASCII + Catppuccin Mocha + battery bar + accurate Tailscale
# Runs once per tmux session (and once outside tmux)

case $- in *i*) ;; *) return ;; esac

# ── 24-bit color helpers ─────────────────────────────────────────────────────
_fg(){ printf "\e[38;2;%s;%s;%sm" "$1" "$2" "$3"; }
_rs(){ printf "\e[0m"; }

# Catppuccin Mocha-ish accents (RGB)
C_TEXT="205 214 244"
C_SUB="166 173 200"
C_MAUVE="203 166 247"
C_BLUE="137 180 250"
C_GREEN="166 227 161"
C_YELL="249 226 175"
C_RED="243 139 168"

# ── tmux/session guard: print once per tmux session ──────────────────────────
_should_print_greeting() {
  if [[ -n "$TMUX" ]] && command -v tmux >/dev/null 2>&1; then
    local sess
    sess="$(tmux display-message -p '#S' 2>/dev/null)"
    if [[ -n "$sess" ]]; then
      if tmux show-environment -t "$sess" GREETING_SHOWN >/dev/null 2>&1; then
        return 1
      fi
      tmux set-environment -t "$sess" GREETING_SHOWN 1 >/dev/null 2>&1
      return 0
    fi
  fi

  # Outside tmux: once per shell
  [[ -n "${__GREETING_SHOWN_OUTSIDE:-}" ]] && return 1
  __GREETING_SHOWN_OUTSIDE=1
  return 0
}

# ── Info helpers (macOS) ─────────────────────────────────────────────────────
_host(){ scutil --get ComputerName 2>/dev/null || hostname; }
_osver(){ sw_vers -productVersion 2>/dev/null; }
_ip_local(){ ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null; }

_uptime_short(){
  local boot now diff d h m
  boot="$(sysctl -n kern.boottime 2>/dev/null | awk -F'[=, ]+' '{print $4}')"
  now="$(date +%s)"
  diff=$((now - boot))
  d=$((diff / 86400))
  h=$(((diff % 86400) / 3600))
  m=$(((diff % 3600) / 60))
  if (( d > 0 )); then
    printf "%dd %dh" "$d" "$h"
  elif (( h > 0 )); then
    printf "%dh %dm" "$h" "$m"
  else
    printf "%dm" "$m"
  fi
}

# Battery % + state + bar
_battery_pct_state() {
  local line pct state
  line="$(pmset -g batt 2>/dev/null | tail -n 1)"
  pct="$(print -r -- "$line" | grep -Eo '[0-9]+%' | head -n 1)"
  state="$(print -r -- "$line" | awk -F'; *' '{print $2}' | tr -d ' ')"
  [[ -n "$pct" ]] || return 1
  printf "%s|%s" "$pct" "$state"
}

_battery_bar() {
  local ps pct state n filled empty i
  ps="$(_battery_pct_state)" || return 0
  pct="${ps%%|*}"
  state="${ps#*|}"
  n="${pct%%%}"
  (( n < 0 )) && n=0
  (( n > 100 )) && n=100

  filled=$(( (n * 30) / 100 ))
  empty=$(( 30 - filled ))

  if (( n < 15 )); then
    _fg 243 139 168   # red
  elif (( n < 30 )); then
    _fg 249 226 175   # yellow
  else
    _fg 166 227 161   # green
  fi

  printf "%s " "$pct"
  printf "["
  for ((i=0;i<filled;i++)); do printf "▮"; done
  _rs
  _fg 166 173 200     # subtext
  for ((i=0;i<empty;i++)); do printf "▯"; done
  _rs
  printf "]"
  _fg 166 173 200; printf " %s" "$state"; _rs
}

# Accurate Tailscale
_tailscale() {
  command -v tailscale >/dev/null 2>&1 || { printf "not installed"; return 0; }

  # If status explicitly says stopped, trust that.
  if tailscale status 2>/dev/null | head -n 1 | grep -qi "stopped"; then
    printf "stopped"
    return 0
  fi

  local ip
  ip="$(tailscale ip -4 2>/dev/null | head -n 1)"
  if [[ -n "$ip" ]]; then
    printf "on (%s)" "$ip"
  else
    printf "starting / not connected"
  fi
}

# ── Left “KUSH” ASCII art (Mocha accents) ────────────────────────────────────
_logo_lines() {
  # Add top padding to vertically center against info column
  print -r -- "                                  "
  print -r -- "                                  "

  print -r -- "  ██╗  ██╗██╗   ██╗███████╗██╗  ██╗"
  print -r -- "  ██║ ██╔╝██║   ██║██╔════╝██║  ██║"
  print -r -- "  █████╔╝ ██║   ██║███████╗███████║"
  print -r -- "  ██╔═██╗ ██║   ██║╚════██║██╔══██║"
  print -r -- "  ██║  ██╗╚██████╔╝███████║██║  ██║"
  print -r -- "  ╚═╝  ╚═╝ ╚═════╝ ╚══════╝╚═╝  ╚═╝"
}


_terminal_greeting() {
  # Don’t clear inside tmux (looks better)
  [[ -z "$TMUX" ]] && clear

  local date time ip
  date="$(date '+%a %d %b %Y')"
  time="$(date '+%H:%M:%S')"
  ip="$(_ip_local)"
  [[ -z "$ip" ]] && ip="—"

  local -a info logo
  info=(
    "User:      $USER"
    "Host:      $(_host)"
    "OS:        macOS $(_osver)"
    "Date:      $date"
    "Time:      $time"
    "Uptime:    $(_uptime_short)"
    "IP:        $ip"
    "Tailscale: $(_tailscale)"
    "Battery:   __BATTERY__"
  )
  logo=("${(@f)$(_logo_lines)}")

  local i left right
  for i in {1..${#info}}; do
    left="${logo[i]:-                                  }"
    right="${info[i]}"

    # Left art gradient-ish: alternate accents by row
    if (( i % 3 == 1 )); then _fg 203 166 247   # mauve
    elif (( i % 3 == 2 )); then _fg 137 180 250 # blue
    else _fg 166 227 161                        # green
    fi
    printf "  %-36s" "$left"
    _rs

    if [[ "$right" == "Battery:   __BATTERY__" ]]; then
      _fg 205 214 244; printf "  %-10s " "Battery:"; _rs
      _battery_bar
      printf "\n"
    else
      _fg 205 214 244; printf "  %s\n" "$right"; _rs
    fi
  done

  printf "\n"
}

_should_print_greeting && _terminal_greeting
